---
- name: Deploy Steve Nginx Application on K3d
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    app_name: steve-nginx
    k8s_manifest_path: "{{ playbook_dir }}/k8s/deployment.yml"

  tasks:
    - name: Check if kubectl is available
      command: kubectl version --client
      register: kubectl_check
      changed_when: false

    - name: Check if K3d cluster is running
      command: kubectl get nodes
      register: cluster_check
      changed_when: false

    - name: Display cluster nodes
      debug:
        msg: "{{ cluster_check.stdout_lines }}"

    - name: Apply Kubernetes manifests
      command: kubectl apply -f {{ k8s_manifest_path }}
      register: apply_result

    - name: Display deployment result
      debug:
        msg: "{{ apply_result.stdout_lines }}"

    - name: Wait for deployment to be ready
      command: kubectl rollout status deployment/{{ app_name }} --timeout=120s
      register: rollout_status

    - name: Display rollout status
      debug:
        msg: "{{ rollout_status.stdout }}"

    - name: Get pods status
      command: kubectl get pods -l app={{ app_name }}
      register: pods_status
      changed_when: false

    - name: Display pods status
      debug:
        msg: "{{ pods_status.stdout_lines }}"

    - name: Get service info
      command: kubectl get svc {{ app_name }}
      register: svc_info
      changed_when: false

    - name: Display service info
      debug:
        msg: "{{ svc_info.stdout_lines }}"

    - name: Deployment complete
      debug:
        msg: |
          ============================================
          Deployment complete!
          Application: {{ app_name }}
          Run: kubectl port-forward svc/{{ app_name }} 8080:80 &
          Then go to PORTS tab and open port 8080
          ============================================
